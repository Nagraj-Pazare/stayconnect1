<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Add PG | StayConnect</title>
  <link rel="stylesheet" href="css/style.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
  <div id="header-placeholder"></div>

  <section class="container my-5">
    <h2 class="text-center mb-4">Add New PG Listing</h2>
    
    <!-- Loading indicator -->
    <div id="appLoading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Initializing application...</p>
    </div>

    <!-- Main form (initially hidden via CSS, not d-none) -->
    <form id="pgForm" class="mx-auto" style="max-width:800px; display: none;">
      <div class="row">
        <div class="col-md-6">
          <!-- Basic Info -->
          <div class="mb-3">
            <label class="form-label">PG Name *</label>
            <input id="pgName" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Owner Name</label>
            <input id="ownerName" class="form-control" />
          </div>
          <div class="mb-3">
            <label class="form-label">Contact Number *</label>
            <input id="contact" class="form-control" type="tel" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Rent (‚Çπ) *</label>
            <input id="rent" type="number" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Facilities (comma separated)</label>
            <input id="facilities" class="form-control" placeholder="WiFi, Food, Laundry, AC" />
          </div>
          <div class="mb-3">
            <label class="form-label">Photo (optional)</label>
            <input id="pgImage" type="file" accept="image/*" class="form-control" />
          </div>
        </div>

        <div class="col-md-6">
          <!-- Location Section -->
          <div class="mb-3">
            <label class="form-label">Search Location *</label>
            <div class="input-group">
              <input id="locationSearch" class="form-control" placeholder="Search area, college, or landmark..." />
              <button type="button" class="btn btn-outline-primary" onclick="searchLocation()">üîç</button>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Selected Location</label>
            <div id="selectedLocation" class="form-control" style="height:120px; overflow-y:auto; background:#f8f9fa;">
              <small class="text-muted">Click on the map to select location</small>
            </div>
          </div>

          <!-- Map Container - MAKE SURE THIS EXISTS -->
          <div class="mb-3">
            <label class="form-label">Select PG Location on Map *</label>
            <div id="locationMap" style="height:250px; border-radius:8px; border:2px solid #e9ecef; background: #f8f9fa;">
              <div class="h-100 d-flex align-items-center justify-content-center text-muted">
                <div class="text-center">
                  <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                  Loading map...
                </div>
              </div>
            </div>
            <small class="text-muted">Click on the map to mark the exact PG location</small>
          </div>

          <!-- Hidden coordinates -->
          <input type="hidden" id="latitude" />
          <input type="hidden" id="longitude" />
          <input type="hidden" id="address" />
        </div>
      </div>

      <button class="btn btn-primary w-100 py-2 mt-3" type="submit" id="submitBtn">
        <span id="submitText">Submit PG Listing</span>
        <div id="submitSpinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status"></div>
      </button>
    </form>
  </section>

  <div id="footer-placeholder"></div>

  <!-- ========== SCRIPT LOADING ORDER ========== -->
  <script src="../config/firebaseConfig.js"></script>
  <script src="../src/js/app.js"></script>
  <script src="../src/js/utils.js"></script>
  <script src="../src/js/auth.js"></script>
  <script src="../src/js/pg.js"></script>

  <script>
    // Load components
    (async function() {
        const [head, foot] = await Promise.all([
            fetch('../src/components/navbar.html').then(r => r.text()),
            fetch('../src/components/footer.html').then(r => r.text())
        ]);
        document.getElementById('header-placeholder').innerHTML = head;
        document.getElementById('footer-placeholder').innerHTML = foot;
    })();

    // Improved Maps loader
    window.addEventListener('firebaseReady', function() {
        console.log('Firebase ready, showing form and loading maps...');
        
        // Show the form first (make it visible)
        document.getElementById('appLoading').style.display = 'none';
        document.getElementById('pgForm').style.display = 'block';
        
        // Wait a bit for DOM to update, then load maps
        setTimeout(() => {
            console.log('Loading Google Maps...');
            loadGoogleMaps();
        }, 100);
    });

    function loadGoogleMaps() {
        // Check if map element exists and is visible
        const mapElement = document.getElementById('locationMap');
        if (!mapElement) {
            console.error('Map element not found!');
            return;
        }
        
        console.log('Map element found, loading Google Maps...');
        
        const script = document.createElement('script');
        script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyB8qAgA-q9hOa4Kbn2zsPeRBZsKaWp7TfA&libraries=places&callback=onMapsLoaded';
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    }

    // Callback when maps are loaded
    window.onMapsLoaded = function() {
        console.log('Google Maps loaded, initializing map...');
        
        // Check if initLocationMap exists and call it
        if (typeof window.initLocationMap === 'function') {
            // Give it a moment to ensure everything is ready
            setTimeout(() => {
                window.initLocationMap();
            }, 500);
        } else {
            console.error('initLocationMap function not found!');
        }
    };
  </script>
</body>
</html>